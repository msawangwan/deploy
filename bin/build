#!/bin/sh

# build
#

echo "ci.io build phase ..."; echo

CONTAINER_PREFIX="ci.io"
CONTAINER_NAME="srv"
CONTAINER_TAG="dev"
CONTAINER_VERSION="0.0.1"
CONTAINER_IMAGE_NAME="$CONTAINER_PREFIX.$CONTAINER_NAME:$CONTAINER_TAG-$CONTAINER_VERSION"

DOCKERFILE_DIR="build"
DOCKERFILE_FILENAME="serve.Dockerfile"
DOCKERFILE_PATH="$DOCKERFILE_DIR/$DOCKERFILE_FILENAME"

DOCKERMOUNT_SOCK="/var/run/docker.sock:/var/run/docker.sock"

# CIIO_SOCK_MNT="/var/run/docker.sock:/var/run/docker.sock"
CIIO_ROOT_IPADDR="$(./bin/parseip)"

export CIIO_ROOT_IPADDR
export DOCKERFILE_DIR

echo "master container addr: $CIIO_ROOT_IPADDR"; echo
echo "pwd: $(pwd)"; echo

ls -al

CHECKENV="$(env | grep -o $CIIO_ROOT_IPADDR)"

if [ "$CHECKENV" == "$CIIO_ROOT_IPADDR" ]; then
    echo "successfully exported master container addr: $CHECKENV"; echo
else
    echo "failed to export master container addr: $CHECKENV"; echo
fi

docker system prune -f
docker build -f "$DOCKERFILE_PATH" -t "$CONTAINER_IMAGE_NAME" .

docker run \
--name "$CONTAINER_PREFIX.$CONTAINER_NAME" \
--rm \
-it \
-e CIIO_ROOT_IPADDR \
-p 9001:80 \
-v "${DOCKERMOUNT_SOCK}" \
"$CONTAINER_IMAGE_NAME"

