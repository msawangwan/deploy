#!/bin/sh

echo "ci.io build phase ..."; echo

CIIO_ROOT_IPADDR="$(./bin/parseip)"

export CIIO_ROOT_IPADDR

echo "master container addr: $CIIO_ROOT_IPADDR"; echo
echo "pwd: $(pwd)"; echo 

ls -al

CHECKENV="$(env | grep CIIO_ROOT_IPADDR)"

if [ "$CHECKENV" == "$CIIO_ROOT_IPADDR" ]; then
    echo "successfully exported master container addr: $CHECKENV"; echo
else
    echo "failed to export master container addr: $CHECKENV"; echo
fi

docker system prune -f
docker build -f dock/serve.Dockerfile  -t ci.io.srv:dev .
docker run --rm -it -e CIIO_ROOT_IPADDR -p 9001:80 -v /var/run/docker.sock:/var/run/docker.sock --name ci.io.srv ci.io.srv:dev
