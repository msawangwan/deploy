#!/bin/sh

echo "ci.io build phase ..."; echo

CONTAINER_NAME="ci.io.srv"
CONTAINER_TAG="dev"
CONTAINER_VERSION="0.1"
CONTAINER_LABEL="$CONTAINER_NAME:$CONTAINER_TAG-$CONTAINER_VERSION"

DF_DIR="build"
DF_NAME="serve.Dockerfile"
DF_PATH="$DF_DIR/$DF_NAME"

CIIO_SOCK_MNT="/var/run/docker.sock:/var/run/docker.sock"
CIIO_ROOT_IPADDR="$(./bin/parseip)"

export CIIO_ROOT_IPADDR
export DF_DIR

echo "master container addr: $CIIO_ROOT_IPADDR"; echo
echo "pwd: $(pwd)"; echo 

ls -al

CHECKENV="$(env | grep -o $CIIO_ROOT_IPADDR)"

if [ "$CHECKENV" == "$CIIO_ROOT_IPADDR" ]; then
    echo "successfully exported master container addr: $CHECKENV"; echo
else
    echo "failed to export master container addr: $CHECKENV"; echo
fi

docker system prune -f
docker build -f "$DF_PATH" -t "$CONTAINER_LABEL" .
docker run --rm -it -e CIIO_ROOT_IPADDR -p 9001:80 -v /var/run/docker.sock:/var/run/docker.sock --name "$CONTAINER_NAME" "$CONTAINER_LABEL"


# docker build -f dock/serve.Dockerfile  -t ci.io.srv:dev .
# docker run --rm -it -e CIIO_ROOT_IPADDR -p 9001:80 -v /var/run/docker.sock:/var/run/docker.sock --name ci.io.srv ci.io.srv:dev
